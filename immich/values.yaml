env:
  REDIS_HOSTNAME: '{{ printf "%s-redis-master" .Release.Name }}'
  DB_HOSTNAME: "${INSTANCE_NAME}-postgresql"
  # Override default template values with secret references
  DB_USERNAME:
    valueFrom:
      secretKeyRef:
        name: ${INSTANCE_NAME}-db-secret
        key: username
  DB_DATABASE_NAME:
    valueFrom:
      secretKeyRef:
        name: ${INSTANCE_NAME}-db-secret
        key: database
  DB_PASSWORD:
    valueFrom:
      secretKeyRef:
        name: ${INSTANCE_NAME}-db-secret
        key: password
  IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'

# Reference additional secrets for environment variables
envFrom:
  - secretRef:
      name: ${INSTANCE_NAME}-app-secret

image:
  tag: ${IMMICH_VERSION}

immich:
  metrics:
    enabled: false
  persistence:
    library:
      enabled: true
      existingClaim: ${INSTANCE_NAME}-library-pvc
  # configuration is immich-config.json converted to yaml
  # ref: https://immich.app/docs/install/config-file/
  configuration:
    # JWT Secret is now sourced from immich-app-secret via envFrom
    # jwt:
    #   secret: "sourced from JWT_SECRET environment variable"
    # trash:
    #   enabled: false
    #   days: 30
    # storageTemplate:
    #   enabled: true
    #   template: "{{y}}/{{y}}-{{MM}}-{{dd}}/{{filename}}"

# PostgreSQL is handled externally via postgres.yaml
postgresql:
  enabled: false

redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      size: 15Gi
      existingClaim: ${INSTANCE_NAME}-redis-pvc
    resources:
      limits:
        memory: 512Mi
        cpu: 150m
      requests:
        memory: 256Mi
        cpu: 100m

server:
  enabled: true
  replicas: 1
  image:
    repository: ghcr.io/immich-app/immich-server
    pullPolicy: IfNotPresent
  
  # Port configuration
  service:
    main:
      type: LoadBalancer
      ports:
        http:
          port: 2283
          targetPort: 2283
  
  # External libraries are added via strategic merge patch
  # See patch.yaml for volume configuration
  
  ingress:
    main:
      enabled: true
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
      hosts:
        - host: ${DOMAIN_NAME}
          paths:
            - path: "/"
      tls: []

machine-learning:
  enabled: true
  image:
    repository: ghcr.io/immich-app/immich-machine-learning
    pullPolicy: IfNotPresent

  env:
    TRANSFORMERS_CACHE: /cache
  
  persistence:
    cache:
      enabled: true
      size: 25Gi
      accessMode: ReadWriteMany
      existingClaim: ${INSTANCE_NAME}-ml-cache-pvc
