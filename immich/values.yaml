controllers:
  main:
    containers:
      main:
        image:
          tag: ${IMMICH_VERSION}
        env:
          REDIS_HOSTNAME: "${INSTANCE_NAME}-redis"
          DB_HOSTNAME: "${INSTANCE_NAME}-postgresql"
          DB_USERNAME:
            valueFrom:
              secretKeyRef:
                name: ${INSTANCE_NAME}-db-secret
                key: username
          DB_DATABASE_NAME:
            valueFrom:
              secretKeyRef:
                name: ${INSTANCE_NAME}-db-secret
                key: database
          DB_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: ${INSTANCE_NAME}-db-secret
                key: password
          IMMICH_MACHINE_LEARNING_URL: "http://${INSTANCE_NAME}-machine-learning:3003"
        envFrom:
          - secretRef:
              name: ${INSTANCE_NAME}-app-secret

immich:
  metrics:
    enabled: false
  persistence:
    library:
      enabled: true
      existingClaim: ${INSTANCE_NAME}-library-pvc
  configuration: {}

valkey:
  enabled: false

server:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-server
            pullPolicy: IfNotPresent
  service:
    main:
      type: LoadBalancer
      ports:
        http:
          port: 2283
          targetPort: 2283
  ingress:
    main:
      enabled: true
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
      hosts:
        - host: ${DOMAIN_NAME}
          paths:
            - path: "/"
              service:
                identifier: main
      tls: []

machine-learning:
  enabled: true
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/immich-app/immich-machine-learning
            pullPolicy: IfNotPresent
          env:
            TRANSFORMERS_CACHE: /cache
            HF_XET_CACHE: /cache/huggingface-xet
            MPLCONFIGDIR: /cache/matplotlib-config
  persistence:
    cache:
      enabled: true
      size: 25Gi
      accessMode: ReadWriteMany
      existingClaim: ${INSTANCE_NAME}-ml-cache-pvc
